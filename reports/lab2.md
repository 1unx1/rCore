# rCore-Lab2

曹伦郗 *2020011020*

#### 功能实现

`sys_get_time`和`sys_task_info`通过`translated_byte_buffer`获得传入的`buffer`的物理地址，由于内核地址空间在可用物理页帧段上是恒等映射，可直接通过`core::ptr::copy`对该物理地址写入数据。若该段虚拟地址被映射到两个物理页，则分别写入。

`sys_mmap`使用当前应用地址空间的页表，尝试对`[start, start+len)`内`VPN`作地址转换，以检查是否存在已被映射页。完成各项检查后，调用`insert_framed_area`将该段虚拟地址作为新的`MapArea`插入当前应用地址空间，其中页属性根据参数`port`设置。

`sys_munmap`的安全检查方法类似，检查是否存在未被映射页。完成各项检查后，调用接口`unmap_from_to`，解除所有与`[start, start+len)`有交集的`MapArea`在交集部分上的映射。

#### 简答作业

1. 从高到低依次为10位保留字段、44位物理页号、2位RSW字段、8位标志位。

   标志位的作用有：

   标识页表项是否合法，控制应用对其地址空间中该页表项对应的虚拟页的访问权限，记录页表项对应的虚拟页是否被访问以及修改等。

   其中：

   - V标识了页表项是否合法；
   - R/W/X分别控制该页表项对应的虚拟页是否可读/可写/可执行，若均为0则该页表项指向下一级页表；
   - U控制该页表项对应的虚拟页是否在用户态U下可被访问；
   - G控制该映射是否对所有地址空间有效；
   - A记录该位上次被清零后，该页表项对应的虚拟页是否被访问过；
   - D记录该位上次被清零后，该页表项对应的虚拟页是否被修改过；

   ---

2. - | Interrupt | Exception Code | Description            |
     | --------- | -------------- | ---------------------- |
     | 0         | 5              | Load access fault      |
     | 0         | 7              | Store/AMO access fault |
     | 0         | 13             | Load page fault        |
     | 0         | 15             | Store/AMO page fault   |

   ---

   - 1. `status`：其`SPP`字段保存了发生缺页异常的特权级。
     2. `scause`：它保存了Trap的原因，即缺页异常。
     3. `sepc`：它保存了触发缺页异常的指令的地址。
     4. `stval`：它保存了导致缺页异常的虚拟地址。
   
   ---
   
   - 1. 减少内存开销。
   
        如果所有虚拟页都被提前加载到内存中，其中许多页面在程序运行过程中不会被访问，这会造成内存资源的浪费。Lazy策略使得程序按运行时需要动态地加载虚拟页，可以减少内存开销。
   
     2. 减少磁盘I/O次数。
   
        如果所有虚拟页都被提前加载到内存中，这会需要大量的磁盘I/O操作。Lazy策略可以减少不必要的磁盘I/O操作，提高程序性能。
   
     3. 减少程序启动耗时。
   
        Lazy策略使得程序不必等到所有虚拟页都被一次性加载到内存中后才开始被执行，从而减少了程序的启动耗时。
   
   ---
   
   - 由于页面大小为4KiB，10GiB内存空间就需要10GiB/4KiB=2.5Mi个页面，则三级页表（多级页表的叶节点）需要2.5Mi/512=5Ki个物理页，二级页表需要5Ki/512=10个物理页，一级页表需要1个物理页。故SV39页表合计占用(5Ki+10+1)*4KiB约20MiB大小内存。
   
   ---
   
   - 1. 在页表项中添加标志位，用于标识该虚拟页是否被加载到了内存中，若访问未被加载到内存中的虚拟页，将触发缺页异常。
     2. 在缺页异常处理过程中，将虚拟页从磁盘加载到内存中。若内存不足，则从已经被加载到了内存中的虚拟页中选择一个页面进行替换。这也是Lazy策略下对缺页的处理方式。
   
   ---
   
   - 1. 页表项中的标志位V会被置零，表示该虚拟页无效。
     2. 页表项中的物理页号字段将被设置为页面在磁盘上的存储位置。
     3. 页表项中的标志位D和标志位A将被置零。
   
   ---
   
3. - 切换至内核态，将要切换到的新地址空间的页表的根节点物理页号写入`satp`中，并刷新TLB。

   - 将内核虚拟页对应的页表项的标志位U设置为0，使得该页不能在用户态U下被访问。

   - 当特权态发生切换时，无需切换地址空间。因此当应用高频进行系统调用时，单页表设计能够避免频繁的地址空间切换带来的开销。

   - 当特权态发生切换时，页表需要更换。

     当执行任务发生切换时，页表需要更换。

#### 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 **以下各位** 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

   > 无

2. 此外，我也参考了 **以下资料** ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

   > [rCore-Tutorial-Book-v3 3.6.0-alpha.1 文档](https://learningos.github.io/rCore-Tutorial-Book-v3/index.html#)
   >
   > [rCore-Tutorial-Guide-2023S 文档 (learningos.github.io)](https://learningos.github.io/rCore-Tutorial-Guide-2023S/index.html)

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。